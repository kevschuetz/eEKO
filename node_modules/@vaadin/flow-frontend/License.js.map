{"version":3,"file":"License.js","sourceRoot":"","sources":["../../../../src/main/frontend/License.ts"],"names":[],"mappings":"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","sourcesContent":["const noLicenseFallbackTimeout = 1000;\n\nexport interface Product {\n  name: string;\n  version: string;\n}\n\nexport interface ProductAndMessage {\n  message: string;\n  messageHtml?: string;\n  product: Product;\n}\n\nexport const findAll = (element: Element | ShadowRoot | Document, tags: string[]): Element[] => {\n  const lightDom = Array.from(element.querySelectorAll(tags.join(', ')));\n  const shadowDom = Array.from(element.querySelectorAll('*'))\n    .filter((e) => e.shadowRoot)\n    .flatMap((e) => findAll(e.shadowRoot!, tags));\n  return [...lightDom, ...shadowDom];\n};\n\nlet licenseCheckListener = false;\n\nconst showNoLicenseFallback = (element: Element, productAndMessage: ProductAndMessage) => {\n  if (!licenseCheckListener) {\n    // When a license check has succeeded, refresh so that all elements are properly shown again\n    window.addEventListener(\n      'message',\n      (e) => {\n        if (e.data === 'validate-license') {\n          window.location.reload();\n        }\n      },\n      false\n    );\n    licenseCheckListener = true;\n  }\n  const overlay = (element as any)._overlayElement;\n  if (overlay) {\n    if (overlay.shadowRoot) {\n      const defaultSlot = overlay.shadowRoot.querySelector('slot:not([name])');\n      if (defaultSlot && defaultSlot.assignedElements().length > 0) {\n        showNoLicenseFallback(defaultSlot.assignedElements()[0], productAndMessage);\n        return;\n      }\n    }\n    showNoLicenseFallback(overlay, productAndMessage);\n    return;\n  }\n\n  const htmlMessage = productAndMessage.messageHtml\n    ? productAndMessage.messageHtml\n    : `${productAndMessage.message} <p>Component: ${productAndMessage.product.name} ${productAndMessage.product.version}</p>`.replace(\n        /https:([^ ]*)/g,\n        \"<a href='https:$1'>https:$1</a>\"\n      );\n\n  element.outerHTML = `<no-license style=\"display:flex;align-items:center;text-align:center;justify-content:center;\"><div>${htmlMessage}</div></no-license>`;\n};\n\nconst productTagNames: Record<string, string[]> = {};\nconst productMissingLicense: Record<string, ProductAndMessage> = {};\n\n/* eslint-disable func-names */\nconst overrideCustomElementsDefine = () => {\n  const { define } = window.customElements;\n\n  window.customElements.define = function (\n    tagName,\n    constructor: CustomElementConstructor & { cvdlName?: string },\n    options\n  ) {\n    const { cvdlName } = constructor;\n    if (cvdlName) {\n      productTagNames[cvdlName] = productTagNames[cvdlName] ?? [];\n      productTagNames[cvdlName].push(tagName);\n\n      const productInfo = productMissingLicense[cvdlName];\n      if (productInfo) {\n        const { connectedCallback } = constructor.prototype;\n        constructor.prototype.connectedCallback = function () {\n          setTimeout(() => showNoLicenseFallback(this, productInfo), noLicenseFallbackTimeout);\n\n          if (connectedCallback) {\n            connectedCallback.call(this);\n          }\n        };\n      }\n    }\n\n    define.call(this, tagName, constructor, options);\n  };\n};\n/* eslint-enable func-names */\n\nexport const licenseCheckOk = (data: Product) => {\n  // eslint-disable-next-line no-console\n  console.debug('License check ok for ', data);\n};\n\nexport const licenseCheckFailed = (data: ProductAndMessage) => {\n  const productName = data.product.name;\n  productMissingLicense[productName] = data;\n  // eslint-disable-next-line no-console\n  console.error('License check failed for ', productName);\n\n  const tags = productTagNames[productName];\n  if (tags?.length > 0) {\n    findAll(document, tags).forEach((element) => {\n      setTimeout(() => showNoLicenseFallback(element, productMissingLicense[productName]), noLicenseFallbackTimeout);\n    });\n  }\n};\n\nexport const licenseCheckNoKey = (data: ProductAndMessage) => {\n  const keyUrl = data.message;\n\n  const productName = data.product.name;\n  data.messageHtml = `No license found. <a target=_blank onclick=\"javascript:window.open(this.href);return false;\" href=\"${keyUrl}\">Go here to start a trial or retrieve your license.</a>`;\n  productMissingLicense[productName] = data;\n  // eslint-disable-next-line no-console\n  console.error('No license found when checking ', productName);\n\n  const tags = productTagNames[productName];\n  if (tags?.length > 0) {\n    findAll(document, tags).forEach((element) => {\n      setTimeout(() => showNoLicenseFallback(element, productMissingLicense[productName]), noLicenseFallbackTimeout);\n    });\n  }\n};\n\noverrideCustomElementsDefine();\n"]}